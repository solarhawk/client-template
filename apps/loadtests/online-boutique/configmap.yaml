apiVersion: v1
kind: ConfigMap
metadata:
  name: boutique-loadtest-script
  labels:
    app.kubernetes.io/name: online-boutique-loadtest
    app.kubernetes.io/part-of: loadtests
    app.kubernetes.io/component: testing
data:
  script.js: |
    // k6 Load Test Script for Online Boutique
    // Simulates realistic user behavior patterns
    // Target: ~60 transactions per minute per service

    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { randomItem, randomIntBetween } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';

    // Configuration
    const FRONTEND_URL = __ENV.FRONTEND_URL || 'http://frontend.online-boutique.svc.cluster.local:80';

    // Product catalog
    const PRODUCTS = [
      '0PUK6V6EV0', '1YMWWN1N4O', '2ZYFJ3GM2N', '66VCHSJNUP',
      '6E92ZMYYFZ', '9SIQT8TOJO', 'L9ECAV7KIM', 'LS4PSXUNUM', 'OLJCESPC7Z',
    ];

    const CURRENCIES = ['EUR', 'USD', 'JPY', 'CAD', 'GBP', 'TRY'];

    export const options = {
      scenarios: {
        user_journey: {
          executor: 'constant-vus',
          vus: parseInt(__ENV.VUS) || 15,
          duration: __ENV.DURATION || '10m',
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<3000'],
        http_req_failed: ['rate<0.05'],
      },
    };

    function generateUserData() {
      return {
        email: `user${randomIntBetween(1, 10000)}@example.com`,
        street_address: `${randomIntBetween(1, 9999)} Main Street`,
        zip_code: `${randomIntBetween(10000, 99999)}`,
        city: 'Springfield',
        state: 'IL',
        country: 'United States',
        credit_card_number: '4111111111111111',
        credit_card_expiration_month: randomIntBetween(1, 12),
        credit_card_expiration_year: randomIntBetween(2025, 2030),
        credit_card_cvv: randomIntBetween(100, 999),
      };
    }

    export default function () {
      const params = {
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      };

      // Visit homepage
      let homeRes = http.get(`${FRONTEND_URL}/`);
      check(homeRes, { 'homepage loaded': (r) => r.status === 200 });
      sleep(randomIntBetween(1, 2));

      // Set currency (20% of the time)
      if (Math.random() < 0.2) {
        const currency = randomItem(CURRENCIES);
        http.post(`${FRONTEND_URL}/setCurrency`, `currency_code=${currency}`, params);
        sleep(1);
      }

      // Browse products (higher frequency for more transactions)
      const productsToView = randomIntBetween(2, 5);
      for (let i = 0; i < productsToView; i++) {
        const productId = randomItem(PRODUCTS);
        let productRes = http.get(`${FRONTEND_URL}/product/${productId}`);
        check(productRes, { 'product page loaded': (r) => r.status === 200 });
        sleep(randomIntBetween(1, 2));

        // Add to cart (50% chance - increased for more transactions)
        if (Math.random() < 0.5) {
          const quantity = randomIntBetween(1, 3);
          http.post(`${FRONTEND_URL}/cart`, `product_id=${productId}&quantity=${quantity}`, params);
          sleep(1);
        }
      }

      // View cart (70% chance)
      if (Math.random() < 0.7) {
        let cartRes = http.get(`${FRONTEND_URL}/cart`);
        check(cartRes, { 'cart page loaded': (r) => r.status === 200 });
        sleep(randomIntBetween(1, 2));
      }

      // Checkout (40% chance - increased for more transactions)
      if (Math.random() < 0.4) {
        const userData = generateUserData();
        http.post(`${FRONTEND_URL}/cart/checkout`,
          `email=${userData.email}&street_address=${encodeURIComponent(userData.street_address)}&` +
          `zip_code=${userData.zip_code}&city=${userData.city}&state=${userData.state}&` +
          `country=${encodeURIComponent(userData.country)}&credit_card_number=${userData.credit_card_number}&` +
          `credit_card_expiration_month=${userData.credit_card_expiration_month}&` +
          `credit_card_expiration_year=${userData.credit_card_expiration_year}&` +
          `credit_card_cvv=${userData.credit_card_cvv}`,
          params
        );
        sleep(randomIntBetween(1, 2));
      }

      // Empty cart (15% chance)
      if (Math.random() < 0.15) {
        http.post(`${FRONTEND_URL}/cart/empty`, '', params);
        sleep(1);
      }

      // Short pause between iterations for higher throughput
      sleep(randomIntBetween(1, 2));
    }
